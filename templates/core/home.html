{% extends 'base.html' %}

{% block title %}Dashboard - Office Suite{% endblock %}

{% block content %}
<div class="dashboard-light">
    <div class="dashboard-container">
        <div class="welcome-header" style="display: flex; justify-content: space-between; align-items: flex-end;">
            <div>
                <h1
                    style="font-size: 2rem; margin-bottom: 0.5rem; color: var(--color-text-main); letter-spacing: -0.025em;">
                    TAS Mission Control</h1>
                <p style="color: var(--color-text-muted);">Real-time Application Monitor &bull; <span
                        style="color: var(--color-primary);">{{ app_name }}</span></p>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 0.875rem; color: var(--color-text-muted); margin-bottom: 0.25rem;">Fleet Status
                </div>
                <div style="display: flex; align-items: center; justify-content: flex-end; gap: 0.5rem;">
                    <span class="live-indicator"><span class="pulse pulse-running" style="margin: 0;"></span> LIVE
                        DATA</span>
                    <div style="font-size: 1.25rem; font-weight: 700; color: #166534;">{{ total_pods }} Nodes</div>
                </div>
            </div>
        </div>

        <div class="stats-grid" style="margin-top: 2rem;">
            <div class="stat-card">
                <div class="stat-label">Critical Pods</div>
                <div class="stat-value">{{ total_pods }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Pod Status: OK</div>
                <div class="stat-value" style="color: #166534;">{{ running_pods }} <span
                        style="font-size: 0.875rem; font-weight: 400; color: var(--color-text-muted); margin-left: 0.5rem;">Active</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Node Failures</div>
                <div class="stat-value" style="color: var(--color-error);">{{ failed_pods }} <span
                        style="font-size: 0.875rem; font-weight: 400; color: var(--color-text-muted); margin-left: 0.5rem;">Alerts</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Kubectl Latency</div>
                <div class="stat-value" style="color: var(--color-primary);">42ms <span
                        style="font-size: 0.875rem; font-weight: 400; color: var(--color-text-muted); margin-left: 0.5rem;">v1.28</span>
                </div>
            </div>
        </div>

        <div style="margin-top: 3rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                    <h2 style="font-size: 1.25rem; color: var(--color-text-main); font-weight: 600;">Pod Management</h2>
                    <p style="font-size: 0.875rem; color: var(--color-text-muted);">Real-time monitoring for 'tas'
                        application</p>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="view-switcher">
                        <button class="switcher-btn active" id="carouselViewBtn" title="Carousel View">
                            <span style="font-size: 1.1rem;">&boxplus;</span> Carousel
                        </button>
                        <button class="switcher-btn" id="listViewBtn" title="List View">
                            <span style="font-size: 1.1rem;">&equiv;</span> List
                        </button>
                    </div>
                    <a href="."
                        style="text-decoration: none; background: white; color: var(--color-text-main); border: 1px solid var(--color-border); padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Refresh
                        Stats</a>
                    <a href="{% url 'node_monitor' %}"
                        style="text-decoration: none; background: #f1f5f9; color: var(--color-text-main); border: 1px solid var(--color-border); padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Cluster
                        Nodes</a>
                </div>
            </div>

            <!-- Carousel View -->
            <div id="carouselViewContainer">
                <div class="carousel-wrapper">
                    <div class="carousel-viewport">
                        <div class="carousel-container" id="carouselTrack">
                            {% for pod in pods %}
                            <div class="carousel-slide">
                                <div class="pod-card-carousel">
                                    <div class="carousel-header">
                                        <div>
                                            <div class="pod-name" style="margin-bottom: 0.25rem;">{{ pod.name }}</div>
                                            <span class="status-badge status-{{ pod.status|lower }}">
                                                {% if pod.status == 'Running' %}
                                                <span class="pulse pulse-running"></span>
                                                {% elif pod.status == 'Pending' %}
                                                <span class="pulse pulse-failed" style="background: #f59e0b;"></span>
                                                {% elif pod.status == 'Failed' or pod.status == 'Error' %}
                                                <span class="pulse pulse-failed"></span>
                                                {% endif %}
                                                {{ pod.status }}
                                            </span>
                                        </div>
                                        <div style="text-align: right;">
                                            <div
                                                style="font-size: 10px; text-transform: uppercase; color: var(--color-text-muted); font-weight: 700;">
                                                IP ADDRESS</div>
                                            <div style="font-family: monospace; font-size: 0.75rem;">{{ pod.ip }}</div>
                                        </div>
                                    </div>

                                    <div
                                        style="font-size: 0.8125rem; background: #f8fafc; padding: 0.75rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                                        <div
                                            style="display: flex; justify-content: space-between; margin-bottom: 0.4rem;">
                                            <span style="color: var(--color-text-muted);">Hosting Node</span>
                                            <span style="font-family: monospace; font-weight: 600;">{{ pod.node
                                                }}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--color-text-muted);">Node Status</span>
                                            <span
                                                style="font-weight: 600; color: {% if pod.node_status == 'Ready' %}#166534{% else %}#991b1b{% endif %};">{{
                                                pod.node_status }}</span>
                                        </div>
                                    </div>

                                    <div class="metric-section">
                                        <div class="gauge-container">
                                            <div class="gauge-label">
                                                <span>CPU USAGE</span>
                                                <span>{{ pod.cpu }}</span>
                                            </div>
                                            <div class="gauge-track">
                                                <div class="gauge-fill" style="width: {{ pod.cpu_percent }}%;"></div>
                                            </div>
                                        </div>
                                        <div class="gauge-container" style="margin-bottom: 0;">
                                            <div class="gauge-label">
                                                <span>MEMORY ALLOCATION</span>
                                                <span>{{ pod.memory }}</span>
                                            </div>
                                            <div class="gauge-track">
                                                <div class="gauge-fill"
                                                    style="width: {{ pod.mem_percent }}%; background: #6366f1;"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div
                                        style="margin-top: auto; padding-top: 1.5rem; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f1f5f9;">
                                        <span style="font-size: 0.75rem; color: var(--color-text-muted);">Restarts: <b
                                                style="color: var(--color-text-main);">{{ pod.restarts }}</b></span>
                                        <button
                                            style="background: none; border: 1px solid var(--color-primary); color: var(--color-primary); padding: 0.35rem 0.75rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; cursor: pointer;">View
                                            Logs</button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="carousel-controls">
                        <button class="carousel-btn" id="prevBtn" title="Previous Pod">&larr;</button>
                        <button class="carousel-btn" id="nextBtn" title="Next Pod">&rarr;</button>
                    </div>
                </div>
            </div>

            <!-- List View -->
            <div id="listViewContainer" class="hidden">
                <div class="pod-list-wrapper">
                    <table class="pod-list-table">
                        <thead>
                            <tr>
                                <th>Pod Name</th>
                                <th>Status</th>
                                <th>IP Address</th>
                                <th>Node / Host</th>
                                <th>CPU Load</th>
                                <th>Memory</th>
                                <th>Restarts</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pod in pods %}
                            <tr>
                                <td style="font-weight: 600; color: var(--color-text-main);">{{ pod.name }}</td>
                                <td>
                                    <span class="status-badge status-{{ pod.status|lower }}"
                                        style="font-size: 0.65rem; padding: 0.15rem 0.5rem;">
                                        {{ pod.status }}
                                    </span>
                                </td>
                                <td style="font-family: monospace; font-size: 0.8rem; color: var(--color-text-muted);">
                                    {{ pod.ip }}</td>
                                <td>
                                    <div style="font-family: monospace; font-size: 0.8rem;">{{ pod.node }}</div>
                                    <div
                                        style="font-size: 0.65rem; color: {% if pod.node_status == 'Ready' %}#166534{% else %}#991b1b{% endif %}; font-weight: 600;">
                                        {{ pod.node_status }}</div>
                                </td>
                                <td>
                                    <div class="compact-gauge">
                                        <span style="font-size: 0.7rem; min-width: 35px;">{{ pod.cpu }}</span>
                                        <div class="compact-gauge-track">
                                            <div class="compact-gauge-fill" style="width: {{ pod.cpu_percent }}%;">
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="compact-gauge">
                                        <span style="font-size: 0.7rem; min-width: 35px;">{{ pod.memory }}</span>
                                        <div class="compact-gauge-track">
                                            <div class="compact-gauge-fill"
                                                style="width: {{ pod.mem_percent }}%; background: #6366f1;"></div>
                                        </div>
                                    </div>
                                </td>
                                <td style="text-align: center; font-weight: 600;">{{ pod.restarts }}</td>
                                <td>
                                    <button
                                        style="background: none; border: 1px solid #e2e8f0; color: var(--color-text-muted); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Logs</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- View Switching Logic ---
        const carouselBtn = document.getElementById('carouselViewBtn');
        const listBtn = document.getElementById('listViewBtn');
        const carouselContainer = document.getElementById('carouselViewContainer');
        const listContainer = document.getElementById('listViewContainer');

        function setView(view) {
            if (view === 'list') {
                carouselContainer.classList.add('hidden');
                listContainer.classList.remove('hidden');
                carouselBtn.classList.remove('active');
                listBtn.classList.add('active');
            } else {
                listContainer.classList.add('hidden');
                carouselContainer.classList.remove('hidden');
                listBtn.classList.remove('active');
                carouselBtn.classList.add('active');
                updateCarousel(); // Re-calculate widths when visible
            }
            localStorage.setItem('dashboard_view', view);
        }

        carouselBtn.addEventListener('click', () => setView('carousel'));
        listBtn.addEventListener('click', () => setView('list'));

        // Load preferred view
        const savedView = localStorage.getItem('dashboard_view') || 'carousel';
        setView(savedView);

        // --- Carousel Logic ---
        const track = document.getElementById('carouselTrack');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const slides = document.querySelectorAll('.carousel-slide');

        let index = 0;
        const totalSlides = slides.length;

        function updateCarousel() {
            if (slides.length === 0 || carouselContainer.classList.contains('hidden')) return;
            const slideWidth = slides[0].offsetWidth + 32; // width + gap
            track.style.transform = `translateX(-${index * slideWidth}px)`;
        }

        function getVisibleSlides() {
            if (window.innerWidth <= 768) return 1;
            if (window.innerWidth <= 1200) return 2;
            return 3;
        }

        nextBtn.addEventListener('click', () => {
            const visible = getVisibleSlides();
            if (index < totalSlides - visible) {
                index++;
                updateCarousel();
            }
        });

        prevBtn.addEventListener('click', () => {
            if (index > 0) {
                index--;
                updateCarousel();
            }
        });

        window.addEventListener('resize', updateCarousel);
    });
</script>
{% endblock %}